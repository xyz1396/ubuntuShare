---
title: "COVID19 Sipros workflow"
author: "xyz"
date: "2021/5/31"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# install Sipros

```{bash}
conda create -n openmpi numpy scipy scikit-learn lxml python=2.7
conda activate openmpi
conda install -c conda-forge openmpi
git clone https://github.com/guo-xuan/Sipros-Ensemble.git
cd Sipros-Ensemble/
vim compiler.mk
# change following lines
# MCC := mpic++
# MGCC := mpicc
make openmp
```

# Preparing the protein databases 

[ensembl covid](ftp://ftp.ensemblgenomes.org/pub/viruses/fasta/sars_cov_2/pep/)
[ensembl Human CH38](http://ftp.ensembl.org/pub/release-104/fasta/homo_sapiens/pep/)
[cRAP protein sequences](https://www.thegpm.org/crap/)
[sars-cov-2 protein from uniprot](https://www.uniprot.org/proteomes/UP000464024)
[human protein from uniprot](https://www.uniprot.org/proteomes/UP000005640)

```{bash}
# remove human proteins in cRAP pollution database
cd /mnt/d/ubuntuShare/COVID19/proteinDB
seqkit grep crap.fasta -p ".*HUMAN.*" -n -r -v > crap.NOhuman.fasta

# combine all proteins
cat crap.NOhuman.fasta \
  Sars-cov-2_uniprot-proteome_UP000464024.fasta \
  Sindbis_virus_uniprot-proteome_UP000006710.fasta\
  Human_uniprot-proteome_UP000005640.fasta \
  >ContaminationVirusHuman.fasta 
  
cd /scratch/yixiong/COVID19
cp /work/omicsbio/dywang/Guangpu/database_2.fasta protein_database.fasta
cd /scratch/yixiong/Sipros-Ensemble/Scripts/
python sipros_prepare_protein_database.py \
  -i /scratch/yixiong/COVID19/protein_database.fasta \
  -o /scratch/yixiong/COVID19/decoy.fasta \
  -c /scratch/yixiong/COVID19/SiprosConfig.cfg

python sipros_prepare_protein_database.py \
  -i /scratch/yixiong/COVID19/ContaminationVirusHuman.fasta \
  -o /scratch/yixiong/COVID19/ContaminationVirusHumanDecoy.fasta \
  -c /scratch/yixiong/COVID19/SiprosConfig.cfg
  
cd /scratch/yixiong/Sipros-Ensemble/bin
```

# convert raw to MS2

[proteowizard](http://proteowizard.sourceforge.net/download.html)
[proteowizard docker](https://hub.docker.com/r/chambm/pwiz-skyline-i-agree-to-the-vendor-licenses)

```{bash}
# docker version cannot work
cd /scratch/yixiong/COVID19/proteowizard
nohup cp /work/omicsbio/dywang/Guangpu/*.raw \
  ../RAW \
  > ../RAW/cp.log.txt 2>&1 & 
mkdir /mywineprefix
singularity pull --name skyline.simg \
  docker://chambm/pwiz-skyline-i-agree-to-the-vendor-licenses
singularity exec \
  --bind=../RAW/:/RAW,mywineprefix:/mywineprefix,../MS2:/MS2 \
  skyline.simg \
  mywine msconvert /RAW/Pan_050721_COVID2.raw \
  -o /MS2 --mzML --singleThreaded

# Thermo RAW reader not implemented: Thermo DLLs only work on Windows    
tar -jxvf pwiz-bin-linux-x86_64-gcc5-release-3_0_21149_88bef26.tar.bz2
./msconvert /work/omicsbio/dywang/Guangpu/*.raw \
  -o /scratch/yixiong/COVID19/ --ms2

cd "C:\green\proteowizard"
./msconvert /work/omicsbio/dywang/Guangpu/*.raw \
  -o /scratch/yixiong/COVID19/ --ms2
```

# run sipros

```{bash}
cd /scratch/yixiong/Sipros-Ensemble/bin
nohup ./Sipros_OpenMP -o /scratch/yixiong/COVID19/output \
  -w /scratch/yixiong/COVID19/MS2/MS2 \
  -c /scratch/yixiong/COVID19/SiprosConfig.cfg \
  > /scratch/yixiong/COVID19/Sipros.log.txt 2>&1 &
  
cd /scratch/yixiong/Sipros-Ensemble/Scripts 
nohup  ./runSiprosFiltering.sh \
  -in /scratch/yixiong/COVID19/output \
  -o /scratch/yixiong/COVID19/FilteringOutput \
  -c /scratch/yixiong/COVID19/SiprosConfig.cfg \
  > /scratch/yixiong/COVID19/Filtering.log.txt 2>&1 &
```


